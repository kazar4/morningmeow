from flask import Flask, request
from twilio import twiml

from gevent.pywsgi import WSGIServer

import fileManage2
import mailScan

from flask_cors import CORS
from flask_cors import cross_origin

import ssl

from gevent import monkey


app = Flask(__name__)
cors = CORS(app)

@app.route('/sms', methods=['POST'])
@cross_origin()
def sms():
    numberRAW = request.form['From']

    number = numberRAW.split("+1")[1]
    message_body = request.form['Body']

    if (fileManage2.checkNumber(number)):
        if "STOP" in message_body:
            fileManage2.deleteData(number)
            fileManage2.addEndDateLog(number)
            print("SMS text included this body: {}".format(message_body))
            print("Deleting {} from Database".format(number))

    return "got text"

@app.route('/mail', methods=['POST'])
@cross_origin()
def mail():
    mailScan.scanMailAndDelete()
    return "got mail"

@app.route('/test', methods=['GET'])
@cross_origin()
def test():
    #mailScan.scanMailAndDelete()
    return "test is working"


http_server = WSGIServer(('', 5000), app, keyfile='morningmeow_com.key', certfile='morningmeow_com.crt', ssl_version=ssl.PROTOCOL_TLSv1)
http_server.serve_forever()

#if __name__ == '__main__':
#    app.run()


